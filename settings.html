<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MightyOps">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/x-icon" href="mwico.ico">
    <title>Settings - MightyOps</title>
    <link rel="stylesheet" href="styles.css?v=22">
    <style>
        .settings-container {
            min-height: calc(100vh - 70px);
            padding: var(--space-xl) var(--space-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .settings-card {
            width: 100%;
            max-width: 500px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            overflow: hidden;
        }
        
        .settings-header {
            padding: var(--space-lg);
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .settings-header h1 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--white);
        }
        
        .settings-section {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .settings-section:last-child {
            border-bottom: none;
        }
        
        .settings-section h2 {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-md);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-input);
            border-radius: var(--radius-md);
        }
        
        .user-avatar {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--white);
            font-size: 1.3rem;
        }
        
        .user-details h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--white);
            margin-bottom: 2px;
        }
        
        .user-details p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            font-family: var(--font-primary);
            font-size: 1rem;
            color: var(--text-primary);
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            transition: all var(--transition-base);
        }
        
        .form-group input:hover {
            background: var(--bg-hover);
            border-color: var(--white-15);
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px var(--accent-blue-dim);
        }
        
        .btn-settings {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            width: 100%;
            padding: 14px 24px;
            font-family: var(--font-primary);
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .btn-settings:active {
            transform: scale(0.98);
        }
        
        .btn-settings:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--accent-blue);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background: #0077ed;
        }
        
        .btn-danger {
            background: var(--accent-red);
            color: var(--white);
        }
        
        .btn-danger:hover {
            background: #ff2d20;
        }
        
        .message {
            padding: var(--space-md);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            text-align: center;
            display: none;
        }
        
        .message.show {
            display: block;
        }
        
        .message.error {
            background: var(--accent-red-dim);
            color: var(--accent-red);
        }
        
        .message.success {
            background: var(--accent-green-dim);
            color: var(--accent-green);
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: var(--space-lg);
            transition: color var(--transition-base);
        }
        
        .back-link:hover {
            color: var(--white);
        }
        
        .version-info {
            text-align: center;
            padding: var(--space-lg);
            color: var(--text-muted);
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="bg-decoration"></div>
        
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <img src="MW Logo.png" alt="MW Logo" class="logo-img">
                <span class="logo-text">Mighty Ops</span>
            </div>
            <a href="home.html" class="btn-icon" title="Back to Home">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
            </a>
        </header>
        
        <div class="settings-container">
            <a href="home.html" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"/>
                    <polyline points="12 19 5 12 12 5"/>
                </svg>
                Back to Home
            </a>
            
            <div class="settings-card">
                <div class="settings-header">
                    <h1>Settings</h1>
                </div>
                
                <!-- Account Section -->
                <div class="settings-section">
                    <h2>Account</h2>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-details">
                            <h3 id="userFullName">User Name</h3>
                            <p id="userEmail">user@example.com</p>
                        </div>
                    </div>
                </div>
                
                <!-- Change Password Section -->
                <div class="settings-section">
                    <h2>Change Password</h2>
                    <form class="settings-form" id="passwordForm">
                        <div class="message" id="passwordMessage"></div>
                        
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" placeholder="Enter current password" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" placeholder="Enter new password" required minlength="6">
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmNewPassword">Confirm New Password</label>
                            <input type="password" id="confirmNewPassword" placeholder="Confirm new password" required>
                        </div>
                        
                        <button type="submit" class="btn-settings btn-primary" id="changePasswordBtn">
                            Change Password
                        </button>
                    </form>
                </div>
                
                <!-- Logout Section -->
                <div class="settings-section">
                    <h2>Session</h2>
                    <button class="btn-settings btn-danger" id="logoutBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        Log Out
                    </button>
                </div>
                
                <div class="version-info">
                    Mighty Ops v1.0
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/.netlify/functions';
        
        // Check authentication
        const userStr = localStorage.getItem('mightyops_user');
        if (!userStr) {
            window.location.href = 'login.html';
        }
        
        const user = JSON.parse(userStr);
        
        // Display user info
        document.getElementById('userFullName').textContent = user.full_name;
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userAvatar').textContent = user.full_name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        
        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to log out?')) {
                localStorage.removeItem('mightyops_user');
                window.location.href = 'login.html';
            }
        });
        
        // Change password handler
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const messageEl = document.getElementById('passwordMessage');
            const submitBtn = document.getElementById('changePasswordBtn');
            
            messageEl.classList.remove('show', 'error', 'success');
            
            if (newPassword !== confirmNewPassword) {
                messageEl.textContent = 'New passwords do not match';
                messageEl.classList.add('show', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                messageEl.textContent = 'New password must be at least 6 characters';
                messageEl.classList.add('show', 'error');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            
            try {
                const response = await fetch(`${API_BASE}/auth-change-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: user.id,
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageEl.textContent = 'Password changed successfully!';
                    messageEl.classList.add('show', 'success');
                    document.getElementById('passwordForm').reset();
                } else {
                    messageEl.textContent = result.error || 'Failed to change password';
                    messageEl.classList.add('show', 'error');
                }
            } catch (error) {
                messageEl.textContent = 'Connection error. Please try again.';
                messageEl.classList.add('show', 'error');
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'Change Password';
        });
    </script>
</body>
</html>


